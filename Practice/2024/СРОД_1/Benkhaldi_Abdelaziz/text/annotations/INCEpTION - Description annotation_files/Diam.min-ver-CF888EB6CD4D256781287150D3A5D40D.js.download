var Diam=(()=>{var k=Object.defineProperty;var re=Object.getOwnPropertyDescriptor;var se=Object.getOwnPropertyNames;var ie=Object.prototype.hasOwnProperty;var oe=(n,e,t)=>e in n?k(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var J=(n,e)=>{for(var t in e)k(n,t,{get:e[t],enumerable:!0})},ae=(n,e,t,r)=>{if(e&&typeof e=="object"||typeof e=="function")for(let s of se(e))!ie.call(n,s)&&s!==t&&k(n,s,{get:()=>e[s],enumerable:!(r=re(e,s))||r.enumerable});return n};var ce=n=>ae(k({},"__esModule",{value:!0}),n);var y=(n,e,t)=>(oe(n,typeof e!="symbol"?e+"":e,t),t);var Ce={};J(Ce,{factory:()=>Oe});var b={LF:`
`,NULL:"\0"};var C=class n{constructor(e){let{command:t,headers:r,body:s,binaryBody:i,escapeHeaderValues:o,skipContentLengthHeader:a}=e;this.command=t,this.headers=Object.assign({},r||{}),i?(this._binaryBody=i,this.isBinaryBody=!0):(this._body=s||"",this.isBinaryBody=!1),this.escapeHeaderValues=o||!1,this.skipContentLengthHeader=a||!1}get body(){return!this._body&&this.isBinaryBody&&(this._body=new TextDecoder().decode(this._binaryBody)),this._body}get binaryBody(){return!this._binaryBody&&!this.isBinaryBody&&(this._binaryBody=new TextEncoder().encode(this._body)),this._binaryBody}static fromRawFrame(e,t){let r={},s=i=>i.replace(/^\s+|\s+$/g,"");for(let i of e.headers.reverse()){let o=i.indexOf(":"),a=s(i[0]),h=s(i[1]);t&&e.command!=="CONNECT"&&e.command!=="CONNECTED"&&(h=n.hdrValueUnEscape(h)),r[a]=h}return new n({command:e.command,headers:r,binaryBody:e.binaryBody,escapeHeaderValues:t})}toString(){return this.serializeCmdAndHeaders()}serialize(){let e=this.serializeCmdAndHeaders();return this.isBinaryBody?n.toUnit8Array(e,this._binaryBody).buffer:e+this._body+b.NULL}serializeCmdAndHeaders(){let e=[this.command];this.skipContentLengthHeader&&delete this.headers["content-length"];for(let t of Object.keys(this.headers||{})){let r=this.headers[t];this.escapeHeaderValues&&this.command!=="CONNECT"&&this.command!=="CONNECTED"?e.push(`${t}:${n.hdrValueEscape(`${r}`)}`):e.push(`${t}:${r}`)}return(this.isBinaryBody||!this.isBodyEmpty()&&!this.skipContentLengthHeader)&&e.push(`content-length:${this.bodyLength()}`),e.join(b.LF)+b.LF+b.LF}isBodyEmpty(){return this.bodyLength()===0}bodyLength(){let e=this.binaryBody;return e?e.length:0}static sizeOfUTF8(e){return e?new TextEncoder().encode(e).length:0}static toUnit8Array(e,t){let r=new TextEncoder().encode(e),s=new Uint8Array([0]),i=new Uint8Array(r.length+t.length+s.length);return i.set(r),i.set(t,r.length),i.set(s,r.length+t.length),i}static marshall(e){return new n(e).serialize()}static hdrValueEscape(e){return e.replace(/\\/g,"\\\\").replace(/\r/g,"\\r").replace(/\n/g,"\\n").replace(/:/g,"\\c")}static hdrValueUnEscape(e){return e.replace(/\\r/g,"\r").replace(/\\n/g,`
`).replace(/\\c/g,":").replace(/\\\\/g,"\\")}};var D=class{constructor(e,t){this.onFrame=e,this.onIncomingPing=t,this._encoder=new TextEncoder,this._decoder=new TextDecoder,this._token=[],this._initState()}parseChunk(e,t=!1){let r;if(e instanceof ArrayBuffer?r=new Uint8Array(e):r=this._encoder.encode(e),t&&r[r.length-1]!==0){let s=new Uint8Array(r.length+1);s.set(r,0),s[r.length]=0,r=s}for(let s=0;s<r.length;s++){let i=r[s];this._onByte(i)}}_collectFrame(e){if(e!==0&&e!==13){if(e===10){this.onIncomingPing();return}this._onByte=this._collectCommand,this._reinjectByte(e)}}_collectCommand(e){if(e!==13){if(e===10){this._results.command=this._consumeTokenAsUTF8(),this._onByte=this._collectHeaders;return}this._consumeByte(e)}}_collectHeaders(e){if(e!==13){if(e===10){this._setupCollectBody();return}this._onByte=this._collectHeaderKey,this._reinjectByte(e)}}_reinjectByte(e){this._onByte(e)}_collectHeaderKey(e){if(e===58){this._headerKey=this._consumeTokenAsUTF8(),this._onByte=this._collectHeaderValue;return}this._consumeByte(e)}_collectHeaderValue(e){if(e!==13){if(e===10){this._results.headers.push([this._headerKey,this._consumeTokenAsUTF8()]),this._headerKey=void 0,this._onByte=this._collectHeaders;return}this._consumeByte(e)}}_setupCollectBody(){let e=this._results.headers.filter(t=>t[0]==="content-length")[0];e?(this._bodyBytesRemaining=parseInt(e[1],10),this._onByte=this._collectBodyFixedSize):this._onByte=this._collectBodyNullTerminated}_collectBodyNullTerminated(e){if(e===0){this._retrievedBody();return}this._consumeByte(e)}_collectBodyFixedSize(e){if(this._bodyBytesRemaining--===0){this._retrievedBody();return}this._consumeByte(e)}_retrievedBody(){this._results.binaryBody=this._consumeTokenAsRaw(),this.onFrame(this._results),this._initState()}_consumeByte(e){this._token.push(e)}_consumeTokenAsUTF8(){return this._decoder.decode(this._consumeTokenAsRaw())}_consumeTokenAsRaw(){let e=new Uint8Array(this._token);return this._token=[],e}_initState(){this._results={command:void 0,headers:[],binaryBody:void 0},this._token=[],this._headerKey=void 0,this._onByte=this._collectFrame}};var v;(function(n){n[n.CONNECTING=0]="CONNECTING",n[n.OPEN=1]="OPEN",n[n.CLOSING=2]="CLOSING",n[n.CLOSED=3]="CLOSED"})(v||(v={}));var _;(function(n){n[n.ACTIVE=0]="ACTIVE",n[n.DEACTIVATING=1]="DEACTIVATING",n[n.INACTIVE=2]="INACTIVE"})(_||(_={}));var p=class{constructor(e){this.versions=e}supportedVersions(){return this.versions.join(",")}protocolVersions(){return this.versions.map(e=>`v${e.replace(".","")}.stomp`)}};p.V1_0="1.0";p.V1_1="1.1";p.V1_2="1.2";p.default=new p([p.V1_0,p.V1_1,p.V1_2]);function Z(n,e){n.terminate=function(){let t=()=>{};this.onerror=t,this.onmessage=t,this.onopen=t;let r=new Date,s=this.onclose;this.onclose=i=>{let o=new Date().getTime()-r.getTime();e(`Discarded socket closed after ${o}ms, with code/reason: ${i.code}/${i.reason}`)},this.close(),s.call(this,{code:4001,reason:"Heartbeat failure, discarding the socket",wasClean:!1})}}var R=class{constructor(e,t,r={}){this._client=e,this._webSocket=t,this._serverFrameHandlers={CONNECTED:s=>{this.debug(`connected to server ${s.headers.server}`),this._connected=!0,this._connectedVersion=s.headers.version,this._connectedVersion===p.V1_2&&(this._escapeHeaderValues=!0),this._setupHeartbeat(s.headers),this.onConnect(s)},MESSAGE:s=>{let i=s.headers.subscription,o=this._subscriptions[i]||this.onUnhandledMessage,a=s,h=this,l=this._connectedVersion===p.V1_2?a.headers.ack:a.headers["message-id"];a.ack=(c={})=>h.ack(l,i,c),a.nack=(c={})=>h.nack(l,i,c),o(a)},RECEIPT:s=>{let i=this._receiptWatchers[s.headers["receipt-id"]];i?(i(s),delete this._receiptWatchers[s.headers["receipt-id"]]):this.onUnhandledReceipt(s)},ERROR:s=>{this.onStompError(s)}},this._counter=0,this._subscriptions={},this._receiptWatchers={},this._partialData="",this._escapeHeaderValues=!1,this._lastServerActivityTS=Date.now(),this.configure(r)}get connectedVersion(){return this._connectedVersion}get connected(){return this._connected}configure(e){Object.assign(this,e)}start(){let e=new D(t=>{let r=C.fromRawFrame(t,this._escapeHeaderValues);this.logRawCommunication||this.debug(`<<< ${r}`),(this._serverFrameHandlers[r.command]||this.onUnhandledFrame)(r)},()=>{this.debug("<<< PONG")});this._webSocket.onmessage=t=>{if(this.debug("Received data"),this._lastServerActivityTS=Date.now(),this.logRawCommunication){let r=t.data instanceof ArrayBuffer?new TextDecoder().decode(t.data):t.data;this.debug(`<<< ${r}`)}e.parseChunk(t.data,this.appendMissingNULLonIncoming)},this._onclose=t=>{this.debug(`Connection closed to ${this._client.brokerURL}`),this._cleanUp(),this.onWebSocketClose(t)},this._webSocket.onclose=this._onclose,this._webSocket.onerror=t=>{this.onWebSocketError(t)},this._webSocket.onopen=()=>{let t=Object.assign({},this.connectHeaders);this.debug("Web Socket Opened..."),t["accept-version"]=this.stompVersions.supportedVersions(),t["heart-beat"]=[this.heartbeatOutgoing,this.heartbeatIncoming].join(","),this._transmit({command:"CONNECT",headers:t})}}_setupHeartbeat(e){if(e.version!==p.V1_1&&e.version!==p.V1_2||!e["heart-beat"])return;let[t,r]=e["heart-beat"].split(",").map(s=>parseInt(s,10));if(this.heartbeatOutgoing!==0&&r!==0){let s=Math.max(this.heartbeatOutgoing,r);this.debug(`send PING every ${s}ms`),this._pinger=setInterval(()=>{this._webSocket.readyState===v.OPEN&&(this._webSocket.send(b.LF),this.debug(">>> PING"))},s)}if(this.heartbeatIncoming!==0&&t!==0){let s=Math.max(this.heartbeatIncoming,t);this.debug(`check PONG every ${s}ms`),this._ponger=setInterval(()=>{let i=Date.now()-this._lastServerActivityTS;i>s*2&&(this.debug(`did not receive server activity for the last ${i}ms`),this._closeOrDiscardWebsocket())},s)}}_closeOrDiscardWebsocket(){this.discardWebsocketOnCommFailure?(this.debug("Discarding websocket, the underlying socket may linger for a while"),this._discardWebsocket()):(this.debug("Issuing close on the websocket"),this._closeWebsocket())}forceDisconnect(){this._webSocket&&(this._webSocket.readyState===v.CONNECTING||this._webSocket.readyState===v.OPEN)&&this._closeOrDiscardWebsocket()}_closeWebsocket(){this._webSocket.onmessage=()=>{},this._webSocket.close()}_discardWebsocket(){this._webSocket.terminate||Z(this._webSocket,e=>this.debug(e)),this._webSocket.terminate()}_transmit(e){let{command:t,headers:r,body:s,binaryBody:i,skipContentLengthHeader:o}=e,a=new C({command:t,headers:r,body:s,binaryBody:i,escapeHeaderValues:this._escapeHeaderValues,skipContentLengthHeader:o}),h=a.serialize();if(this.logRawCommunication?this.debug(`>>> ${h}`):this.debug(`>>> ${a}`),this.forceBinaryWSFrames&&typeof h=="string"&&(h=new TextEncoder().encode(h)),typeof h!="string"||!this.splitLargeFrames)this._webSocket.send(h);else{let l=h;for(;l.length>0;){let c=l.substring(0,this.maxWebSocketChunkSize);l=l.substring(this.maxWebSocketChunkSize),this._webSocket.send(c),this.debug(`chunk sent = ${c.length}, remaining = ${l.length}`)}}}dispose(){if(this.connected)try{let e=Object.assign({},this.disconnectHeaders);e.receipt||(e.receipt=`close-${this._counter++}`),this.watchForReceipt(e.receipt,t=>{this._closeWebsocket(),this._cleanUp(),this.onDisconnect(t)}),this._transmit({command:"DISCONNECT",headers:e})}catch(e){this.debug(`Ignoring error during disconnect ${e}`)}else(this._webSocket.readyState===v.CONNECTING||this._webSocket.readyState===v.OPEN)&&this._closeWebsocket()}_cleanUp(){this._connected=!1,this._pinger&&clearInterval(this._pinger),this._ponger&&clearInterval(this._ponger)}publish(e){let{destination:t,headers:r,body:s,binaryBody:i,skipContentLengthHeader:o}=e,a=Object.assign({destination:t},r);this._transmit({command:"SEND",headers:a,body:s,binaryBody:i,skipContentLengthHeader:o})}watchForReceipt(e,t){this._receiptWatchers[e]=t}subscribe(e,t,r={}){r=Object.assign({},r),r.id||(r.id=`sub-${this._counter++}`),r.destination=e,this._subscriptions[r.id]=t,this._transmit({command:"SUBSCRIBE",headers:r});let s=this;return{id:r.id,unsubscribe(i){return s.unsubscribe(r.id,i)}}}unsubscribe(e,t={}){t=Object.assign({},t),delete this._subscriptions[e],t.id=e,this._transmit({command:"UNSUBSCRIBE",headers:t})}begin(e){let t=e||`tx-${this._counter++}`;this._transmit({command:"BEGIN",headers:{transaction:t}});let r=this;return{id:t,commit(){r.commit(t)},abort(){r.abort(t)}}}commit(e){this._transmit({command:"COMMIT",headers:{transaction:e}})}abort(e){this._transmit({command:"ABORT",headers:{transaction:e}})}ack(e,t,r={}){r=Object.assign({},r),this._connectedVersion===p.V1_2?r.id=e:r["message-id"]=e,r.subscription=t,this._transmit({command:"ACK",headers:r})}nack(e,t,r={}){return r=Object.assign({},r),this._connectedVersion===p.V1_2?r.id=e:r["message-id"]=e,r.subscription=t,this._transmit({command:"NACK",headers:r})}};var ee=function(n,e,t,r){function s(i){return i instanceof t?i:new t(function(o){o(i)})}return new(t||(t=Promise))(function(i,o){function a(c){try{l(r.next(c))}catch(d){o(d)}}function h(c){try{l(r.throw(c))}catch(d){o(d)}}function l(c){c.done?i(c.value):s(c.value).then(a,h)}l((r=r.apply(n,e||[])).next())})},P=class{constructor(e={}){this.stompVersions=p.default,this.connectionTimeout=0,this.reconnectDelay=5e3,this.heartbeatIncoming=1e4,this.heartbeatOutgoing=1e4,this.splitLargeFrames=!1,this.maxWebSocketChunkSize=8*1024,this.forceBinaryWSFrames=!1,this.appendMissingNULLonIncoming=!1,this.state=_.INACTIVE;let t=()=>{};this.debug=t,this.beforeConnect=t,this.onConnect=t,this.onDisconnect=t,this.onUnhandledMessage=t,this.onUnhandledReceipt=t,this.onUnhandledFrame=t,this.onStompError=t,this.onWebSocketClose=t,this.onWebSocketError=t,this.logRawCommunication=!1,this.onChangeState=t,this.connectHeaders={},this._disconnectHeaders={},this.configure(e)}get webSocket(){return this._stompHandler?this._stompHandler._webSocket:void 0}get disconnectHeaders(){return this._disconnectHeaders}set disconnectHeaders(e){this._disconnectHeaders=e,this._stompHandler&&(this._stompHandler.disconnectHeaders=this._disconnectHeaders)}get connected(){return!!this._stompHandler&&this._stompHandler.connected}get connectedVersion(){return this._stompHandler?this._stompHandler.connectedVersion:void 0}get active(){return this.state===_.ACTIVE}_changeState(e){this.state=e,this.onChangeState(e)}configure(e){Object.assign(this,e)}activate(){if(this.state===_.DEACTIVATING)throw this.debug("Still DEACTIVATING, please await call to deactivate before trying to re-activate"),new Error("Still DEACTIVATING, can not activate now");if(this.active){this.debug("Already ACTIVE, ignoring request to activate");return}this._changeState(_.ACTIVE),this._connect()}_connect(){return ee(this,void 0,void 0,function*(){if(this.connected){this.debug("STOMP: already connected, nothing to do");return}if(yield this.beforeConnect(),!this.active){this.debug("Client has been marked inactive, will not attempt to connect");return}this.connectionTimeout>0&&(this._connectionWatcher&&clearTimeout(this._connectionWatcher),this._connectionWatcher=setTimeout(()=>{this.connected||(this.debug(`Connection not established in ${this.connectionTimeout}ms, closing socket`),this.forceDisconnect())},this.connectionTimeout)),this.debug("Opening Web Socket...");let e=this._createWebSocket();this._stompHandler=new R(this,e,{debug:this.debug,stompVersions:this.stompVersions,connectHeaders:this.connectHeaders,disconnectHeaders:this._disconnectHeaders,heartbeatIncoming:this.heartbeatIncoming,heartbeatOutgoing:this.heartbeatOutgoing,splitLargeFrames:this.splitLargeFrames,maxWebSocketChunkSize:this.maxWebSocketChunkSize,forceBinaryWSFrames:this.forceBinaryWSFrames,logRawCommunication:this.logRawCommunication,appendMissingNULLonIncoming:this.appendMissingNULLonIncoming,discardWebsocketOnCommFailure:this.discardWebsocketOnCommFailure,onConnect:t=>{if(this._connectionWatcher&&(clearTimeout(this._connectionWatcher),this._connectionWatcher=void 0),!this.active){this.debug("STOMP got connected while deactivate was issued, will disconnect now"),this._disposeStompHandler();return}this.onConnect(t)},onDisconnect:t=>{this.onDisconnect(t)},onStompError:t=>{this.onStompError(t)},onWebSocketClose:t=>{this._stompHandler=void 0,this.state===_.DEACTIVATING&&(this._resolveSocketClose(),this._resolveSocketClose=void 0,this._changeState(_.INACTIVE)),this.onWebSocketClose(t),this.active&&this._schedule_reconnect()},onWebSocketError:t=>{this.onWebSocketError(t)},onUnhandledMessage:t=>{this.onUnhandledMessage(t)},onUnhandledReceipt:t=>{this.onUnhandledReceipt(t)},onUnhandledFrame:t=>{this.onUnhandledFrame(t)}}),this._stompHandler.start()})}_createWebSocket(){let e;return this.webSocketFactory?e=this.webSocketFactory():e=new WebSocket(this.brokerURL,this.stompVersions.protocolVersions()),e.binaryType="arraybuffer",e}_schedule_reconnect(){this.reconnectDelay>0&&(this.debug(`STOMP: scheduling reconnection in ${this.reconnectDelay}ms`),this._reconnector=setTimeout(()=>{this._connect()},this.reconnectDelay))}deactivate(){return ee(this,void 0,void 0,function*(){let e;if(this.state!==_.ACTIVE)return this.debug(`Already ${_[this.state]}, ignoring call to deactivate`),Promise.resolve();if(this._changeState(_.DEACTIVATING),this._reconnector&&clearTimeout(this._reconnector),this._stompHandler&&this.webSocket.readyState!==v.CLOSED)e=new Promise((t,r)=>{this._resolveSocketClose=t});else return this._changeState(_.INACTIVE),Promise.resolve();return this._disposeStompHandler(),e})}forceDisconnect(){this._stompHandler&&this._stompHandler.forceDisconnect()}_disposeStompHandler(){this._stompHandler&&(this._stompHandler.dispose(),this._stompHandler=null)}publish(e){this._stompHandler.publish(e)}watchForReceipt(e,t){this._stompHandler.watchForReceipt(e,t)}subscribe(e,t,r={}){return this._stompHandler.subscribe(e,t,r)}unsubscribe(e,t={}){this._stompHandler.unsubscribe(e,t)}begin(e){return this._stompHandler.begin(e)}commit(e){this._stompHandler.commit(e)}abort(e){this._stompHandler.abort(e)}ack(e,t,r={}){this._stompHandler.ack(e,t,r)}nack(e,t,r={}){this._stompHandler.nack(e,t,r)}};var H=class{constructor(e){this.client=e}get outgoing(){return this.client.heartbeatOutgoing}set outgoing(e){this.client.heartbeatOutgoing=e}get incoming(){return this.client.heartbeatIncoming}set incoming(e){this.client.heartbeatIncoming=e}};var T=class extends P{constructor(e){super(),this.maxWebSocketFrameSize=16*1024,this._heartbeatInfo=new H(this),this.reconnect_delay=0,this.webSocketFactory=e,this.debug=(...t)=>{console.log(...t)}}_parseConnect(...e){let t,r,s,i={};if(e.length<2)throw new Error("Connect requires at least 2 arguments");if(typeof e[1]=="function")[i,r,s,t]=e;else switch(e.length){case 6:[i.login,i.passcode,r,s,t,i.host]=e;break;default:[i.login,i.passcode,r,s,t]=e}return[i,r,s,t]}connect(...e){let t=this._parseConnect(...e);t[0]&&(this.connectHeaders=t[0]),t[1]&&(this.onConnect=t[1]),t[2]&&(this.onStompError=t[2]),t[3]&&(this.onWebSocketClose=t[3]),super.activate()}disconnect(e,t={}){e&&(this.onDisconnect=e),this.disconnectHeaders=t,super.deactivate()}send(e,t={},r=""){t=Object.assign({},t);let s=t["content-length"]===!1;s&&delete t["content-length"],this.publish({destination:e,headers:t,body:r,skipContentLengthHeader:s})}set reconnect_delay(e){this.reconnectDelay=e}get ws(){return this.webSocket}get version(){return this.connectedVersion}get onreceive(){return this.onUnhandledMessage}set onreceive(e){this.onUnhandledMessage=e}get onreceipt(){return this.onUnhandledReceipt}set onreceipt(e){this.onUnhandledReceipt=e}get heartbeat(){return this._heartbeatInfo}set heartbeat(e){this.heartbeatIncoming=e.incoming,this.heartbeatOutgoing=e.outgoing}};var S=class n{static client(e,t){t==null&&(t=p.default.protocolVersions());let r=()=>{let s=n.WebSocketClass||WebSocket;return new s(e,t)};return new T(r)}static over(e){let t;return typeof e=="function"?t=e:(console.warn("Stomp.over did not receive a factory, auto reconnect will not work. Please see https://stomp-js.github.io/api-docs/latest/classes/Stomp.html#over"),t=()=>e),new T(t)}};S.WebSocketClass=null;var Y={};J(Y,{JsonPatchError:()=>u,_areEquals:()=>x,applyOperation:()=>E,applyPatch:()=>O,applyReducer:()=>fe,deepClone:()=>de,getValueByPointer:()=>U,validate:()=>ne,validator:()=>V});var he=function(){var n=function(e,t){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(r,s){r.__proto__=s}||function(r,s){for(var i in s)s.hasOwnProperty(i)&&(r[i]=s[i])},n(e,t)};return function(e,t){n(e,t);function r(){this.constructor=e}e.prototype=t===null?Object.create(t):(r.prototype=t.prototype,new r)}}(),le=Object.prototype.hasOwnProperty;function B(n,e){return le.call(n,e)}function W(n){if(Array.isArray(n)){for(var e=new Array(n.length),t=0;t<e.length;t++)e[t]=""+t;return e}if(Object.keys)return Object.keys(n);var r=[];for(var s in n)B(n,s)&&r.push(s);return r}function m(n){switch(typeof n){case"object":return JSON.parse(JSON.stringify(n));case"undefined":return null;default:return n}}function F(n){for(var e=0,t=n.length,r;e<t;){if(r=n.charCodeAt(e),r>=48&&r<=57){e++;continue}return!1}return!0}function w(n){return n.indexOf("/")===-1&&n.indexOf("~")===-1?n:n.replace(/~/g,"~0").replace(/\//g,"~1")}function I(n){return n.replace(/~1/g,"/").replace(/~0/g,"~")}function L(n){if(n===void 0)return!0;if(n){if(Array.isArray(n)){for(var e=0,t=n.length;e<t;e++)if(L(n[e]))return!0}else if(typeof n=="object"){for(var r=W(n),s=r.length,i=0;i<s;i++)if(L(n[r[i]]))return!0}}return!1}function te(n,e){var t=[n];for(var r in e){var s=typeof e[r]=="object"?JSON.stringify(e[r],null,2):e[r];typeof s!="undefined"&&t.push(r+": "+s)}return t.join(`
`)}var N=function(n){he(e,n);function e(t,r,s,i,o){var a=this.constructor,h=n.call(this,te(t,{name:r,index:s,operation:i,tree:o}))||this;return h.name=r,h.index=s,h.operation=i,h.tree=o,Object.setPrototypeOf(h,a.prototype),h.message=te(t,{name:r,index:s,operation:i,tree:o}),h}return e}(Error);var u=N,de=m,A={add:function(n,e,t){return n[e]=this.value,{newDocument:t}},remove:function(n,e,t){var r=n[e];return delete n[e],{newDocument:t,removed:r}},replace:function(n,e,t){var r=n[e];return n[e]=this.value,{newDocument:t,removed:r}},move:function(n,e,t){var r=U(t,this.path);r&&(r=m(r));var s=E(t,{op:"remove",path:this.from}).removed;return E(t,{op:"add",path:this.path,value:s}),{newDocument:t,removed:r}},copy:function(n,e,t){var r=U(t,this.from);return E(t,{op:"add",path:this.path,value:m(r)}),{newDocument:t}},test:function(n,e,t){return{newDocument:t,test:x(n[e],this.value)}},_get:function(n,e,t){return this.value=n[e],{newDocument:t}}},ue={add:function(n,e,t){return F(e)?n.splice(e,0,this.value):n[e]=this.value,{newDocument:t,index:e}},remove:function(n,e,t){var r=n.splice(e,1);return{newDocument:t,removed:r[0]}},replace:function(n,e,t){var r=n[e];return n[e]=this.value,{newDocument:t,removed:r}},move:A.move,copy:A.copy,test:A.test,_get:A._get};function U(n,e){if(e=="")return n;var t={op:"_get",path:e};return E(n,t),t.value}function E(n,e,t,r,s,i){if(t===void 0&&(t=!1),r===void 0&&(r=!0),s===void 0&&(s=!0),i===void 0&&(i=0),t&&(typeof t=="function"?t(e,0,n,e.path):V(e,0)),e.path===""){var o={newDocument:n};if(e.op==="add")return o.newDocument=e.value,o;if(e.op==="replace")return o.newDocument=e.value,o.removed=n,o;if(e.op==="move"||e.op==="copy")return o.newDocument=U(n,e.from),e.op==="move"&&(o.removed=n),o;if(e.op==="test"){if(o.test=x(n,e.value),o.test===!1)throw new u("Test operation failed","TEST_OPERATION_FAILED",i,e,n);return o.newDocument=n,o}else{if(e.op==="remove")return o.removed=n,o.newDocument=null,o;if(e.op==="_get")return e.value=n,o;if(t)throw new u("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",i,e,n);return o}}else{r||(n=m(n));var a=e.path||"",h=a.split("/"),l=n,c=1,d=h.length,g=void 0,f=void 0,z=void 0;for(typeof t=="function"?z=t:z=V;;){if(f=h[c],f&&f.indexOf("~")!=-1&&(f=I(f)),s&&(f=="__proto__"||f=="prototype"&&c>0&&h[c-1]=="constructor"))throw new TypeError("JSON-Patch: modifying `__proto__` or `constructor/prototype` prop is banned for security reasons, if this was on purpose, please set `banPrototypeModifications` flag false and pass it to this function. More info in fast-json-patch README");if(t&&g===void 0&&(l[f]===void 0?g=h.slice(0,c).join("/"):c==d-1&&(g=e.path),g!==void 0&&z(e,0,n,g)),c++,Array.isArray(l)){if(f==="-")f=l.length;else{if(t&&!F(f))throw new u("Expected an unsigned base-10 integer value, making the new referenced value the array element with the zero-based index","OPERATION_PATH_ILLEGAL_ARRAY_INDEX",i,e,n);F(f)&&(f=~~f)}if(c>=d){if(t&&e.op==="add"&&f>l.length)throw new u("The specified index MUST NOT be greater than the number of elements in the array","OPERATION_VALUE_OUT_OF_BOUNDS",i,e,n);var o=ue[e.op].call(e,l,f,n);if(o.test===!1)throw new u("Test operation failed","TEST_OPERATION_FAILED",i,e,n);return o}}else if(c>=d){var o=A[e.op].call(e,l,f,n);if(o.test===!1)throw new u("Test operation failed","TEST_OPERATION_FAILED",i,e,n);return o}if(l=l[f],t&&c<d&&(!l||typeof l!="object"))throw new u("Cannot perform operation at the desired path","OPERATION_PATH_UNRESOLVABLE",i,e,n)}}}function O(n,e,t,r,s){if(r===void 0&&(r=!0),s===void 0&&(s=!0),t&&!Array.isArray(e))throw new u("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");r||(n=m(n));for(var i=new Array(e.length),o=0,a=e.length;o<a;o++)i[o]=E(n,e[o],t,!0,s,o),n=i[o].newDocument;return i.newDocument=n,i}function fe(n,e,t){var r=E(n,e);if(r.test===!1)throw new u("Test operation failed","TEST_OPERATION_FAILED",t,e,n);return r.newDocument}function V(n,e,t,r){if(typeof n!="object"||n===null||Array.isArray(n))throw new u("Operation is not an object","OPERATION_NOT_AN_OBJECT",e,n,t);if(A[n.op]){if(typeof n.path!="string")throw new u("Operation `path` property is not a string","OPERATION_PATH_INVALID",e,n,t);if(n.path.indexOf("/")!==0&&n.path.length>0)throw new u('Operation `path` property must start with "/"',"OPERATION_PATH_INVALID",e,n,t);if((n.op==="move"||n.op==="copy")&&typeof n.from!="string")throw new u("Operation `from` property is not present (applicable in `move` and `copy` operations)","OPERATION_FROM_REQUIRED",e,n,t);if((n.op==="add"||n.op==="replace"||n.op==="test")&&n.value===void 0)throw new u("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_REQUIRED",e,n,t);if((n.op==="add"||n.op==="replace"||n.op==="test")&&L(n.value))throw new u("Operation `value` property is not present (applicable in `add`, `replace` and `test` operations)","OPERATION_VALUE_CANNOT_CONTAIN_UNDEFINED",e,n,t);if(t){if(n.op=="add"){var s=n.path.split("/").length,i=r.split("/").length;if(s!==i+1&&s!==i)throw new u("Cannot perform an `add` operation at the desired path","OPERATION_PATH_CANNOT_ADD",e,n,t)}else if(n.op==="replace"||n.op==="remove"||n.op==="_get"){if(n.path!==r)throw new u("Cannot perform the operation at a path that does not exist","OPERATION_PATH_UNRESOLVABLE",e,n,t)}else if(n.op==="move"||n.op==="copy"){var o={op:"_get",path:n.from,value:void 0},a=ne([o],t);if(a&&a.name==="OPERATION_PATH_UNRESOLVABLE")throw new u("Cannot perform the operation from a path that does not exist","OPERATION_FROM_UNRESOLVABLE",e,n,t)}}}else throw new u("Operation `op` property is not one of operations defined in RFC-6902","OPERATION_OP_INVALID",e,n,t)}function ne(n,e,t){try{if(!Array.isArray(n))throw new u("Patch sequence must be an array","SEQUENCE_NOT_AN_ARRAY");if(e)O(m(e),m(n),t||!0);else{t=t||V;for(var r=0;r<n.length;r++)t(n[r],r,e,void 0)}}catch(s){if(s instanceof u)return s;throw s}}function x(n,e){if(n===e)return!0;if(n&&e&&typeof n=="object"&&typeof e=="object"){var t=Array.isArray(n),r=Array.isArray(e),s,i,o;if(t&&r){if(i=n.length,i!=e.length)return!1;for(s=i;s--!==0;)if(!x(n[s],e[s]))return!1;return!0}if(t!=r)return!1;var a=Object.keys(n);if(i=a.length,i!==Object.keys(e).length)return!1;for(s=i;s--!==0;)if(!e.hasOwnProperty(a[s]))return!1;for(s=i;s--!==0;)if(o=a[s],!x(n[o],e[o]))return!1;return!0}return n!==n&&e!==e}var Q={};J(Q,{compare:()=>be,generate:()=>K,observe:()=>we,unobserve:()=>ve});var X=new WeakMap,pe=function(){function n(e){this.observers=new Map,this.obj=e}return n}(),me=function(){function n(e,t){this.callback=e,this.observer=t}return n}();function ge(n){return X.get(n)}function _e(n,e){return n.observers.get(e)}function ye(n,e){n.observers.delete(e.callback)}function ve(n,e){e.unobserve()}function we(n,e){var t=[],r,s=ge(n);if(!s)s=new pe(n),X.set(n,s);else{var i=_e(s,e);r=i&&i.observer}if(r)return r;if(r={},s.value=m(n),e){r.callback=e,r.next=null;var o=function(){K(r)},a=function(){clearTimeout(r.next),r.next=setTimeout(o)};typeof window!="undefined"&&(window.addEventListener("mouseup",a),window.addEventListener("keyup",a),window.addEventListener("mousedown",a),window.addEventListener("keydown",a),window.addEventListener("change",a))}return r.patches=t,r.object=n,r.unobserve=function(){K(r),clearTimeout(r.next),ye(s,r),typeof window!="undefined"&&(window.removeEventListener("mouseup",a),window.removeEventListener("keyup",a),window.removeEventListener("mousedown",a),window.removeEventListener("keydown",a),window.removeEventListener("change",a))},s.observers.set(e,new me(e,r)),r}function K(n,e){e===void 0&&(e=!1);var t=X.get(n.object);q(t.value,n.object,n.patches,"",e),n.patches.length&&O(t.value,n.patches);var r=n.patches;return r.length>0&&(n.patches=[],n.callback&&n.callback(r)),r}function q(n,e,t,r,s){if(e!==n){typeof e.toJSON=="function"&&(e=e.toJSON());for(var i=W(e),o=W(n),a=!1,h=!1,l=o.length-1;l>=0;l--){var c=o[l],d=n[c];if(B(e,c)&&!(e[c]===void 0&&d!==void 0&&Array.isArray(e)===!1)){var g=e[c];typeof d=="object"&&d!=null&&typeof g=="object"&&g!=null&&Array.isArray(d)===Array.isArray(g)?q(d,g,t,r+"/"+w(c),s):d!==g&&(a=!0,s&&t.push({op:"test",path:r+"/"+w(c),value:m(d)}),t.push({op:"replace",path:r+"/"+w(c),value:m(g)}))}else Array.isArray(n)===Array.isArray(e)?(s&&t.push({op:"test",path:r+"/"+w(c),value:m(d)}),t.push({op:"remove",path:r+"/"+w(c)}),h=!0):(s&&t.push({op:"test",path:r,value:n}),t.push({op:"replace",path:r,value:e}),a=!0)}if(!(!h&&i.length==o.length))for(var l=0;l<i.length;l++){var c=i[l];!B(n,c)&&e[c]!==void 0&&t.push({op:"add",path:r+"/"+w(c),value:m(e[c])})}}}function be(n,e,t){t===void 0&&(t=!1);var r=[];return q(n,e,r,"",t),r}var rt=Object.assign({},Y,Q,{JsonPatchError:N,deepClone:m,escapePathComponent:w,unescapePathComponent:I});var j=class{constructor(){y(this,"stompClient");y(this,"webSocket");y(this,"initSubscription");y(this,"updateSubscription");y(this,"diff");y(this,"data");y(this,"onConnect")}connect(e){if(this.stompClient){console.log("Already connected");return}let t=window.location.protocol==="https:"?"wss:":"ws:",r=new URL(e);r.protocol=t,this.stompClient=S.over(()=>new WebSocket(r.toString())),this.stompClient.reconnectDelay=5e3,this.stompClient.onConnect=s=>{this.stompClient.subscribe("/user/queue/errors",this.handleProtocolError),this.onConnect&&this.onConnect(s)},this.stompClient.onStompError=this.handleBrokerError,this.stompClient.activate()}disconnect(){var e;this.stompClient.deactivate(),(e=this.stompClient.webSocket)==null||e.close()}handleBrokerError(e){console.log("Broker reported error: "+e.headers.message),console.log("Additional details: "+e.body)}handleProtocolError(e){console.log(e)}subscribeToViewport(e,t){this.unsubscribeFromViewport(),this.initSubscription=this.stompClient.subscribe("/app"+e,r=>{this.data=JSON.parse(r.body),this.diff=null,t(this.data)}),this.updateSubscription=this.stompClient.subscribe("/topic"+e,r=>{let s=JSON.parse(r.body);this.data=O(this.data,s.diff).newDocument,this.diff=s.diff,t(this.data)})}unsubscribeFromViewport(){this.initSubscription&&this.initSubscription.unsubscribe(),this.updateSubscription&&this.updateSubscription.unsubscribe()}};Object.prototype.hasOwnProperty.call(document,"DIAM_TRANSPORT_BUFFER")||(document.DIAM_TRANSPORT_BUFFER={});var M=document.DIAM_TRANSPORT_BUFFER,$=class n{constructor(e){y(this,"ajaxEndpoint");this.ajaxEndpoint=e}static isFocusInFeatureEditor(){var e;return((e=document.activeElement)==null?void 0:e.closest(".feature-editors-sidebar"))!=null}static performAjaxCall(e){if(this.isFocusInFeatureEditor()){document.activeElement instanceof HTMLElement&&document.activeElement.blur(),setTimeout(()=>e(),50);return}e()}selectAnnotation(e,t){n.performAjaxCall(()=>{Wicket.Ajax.ajax({m:"POST",u:this.ajaxEndpoint,ep:{action:"selectAnnotation",id:e,scrollTo:t==null?void 0:t.scrollTo}})})}scrollTo(e){n.performAjaxCall(()=>{Wicket.Ajax.ajax({m:"POST",u:this.ajaxEndpoint,ep:{action:"scrollTo",id:e.id,offset:e.offset}})})}createSpanAnnotation(e,t){n.performAjaxCall(()=>{Wicket.Ajax.ajax({m:"POST",u:this.ajaxEndpoint,ep:{action:"spanOpenDialog",offsets:JSON.stringify(e),spanText:t}})})}moveSpanAnnotation(e,t){n.performAjaxCall(()=>{Wicket.Ajax.ajax({m:"POST",u:this.ajaxEndpoint,ep:{action:"moveSpan",id:e,offsets:JSON.stringify(t)}})})}createRelationAnnotation(e,t,r){let{clientX:s,clientY:i,overlay:o}=this.calculateClientPosition(r);n.performAjaxCall(()=>{new Promise((a,h)=>{Wicket.Ajax.ajax({m:"POST",u:this.ajaxEndpoint,ep:{action:"arcOpenDialog",originSpanId:e,targetSpanId:t,clientX:s,clientY:i},sh:[()=>{a()}],eh:[()=>{h(new Error("Error while trying to create relation"))}]})}).then(()=>this.closeOverlayWhenContextMenuIsHidden(o))})}deleteAnnotation(e){n.performAjaxCall(()=>{Wicket.Ajax.ajax({m:"POST",u:this.ajaxEndpoint,ep:{action:"deleteAnnotation",id:e}})})}triggerExtensionAction(e){n.performAjaxCall(()=>{Wicket.Ajax.ajax({m:"POST",u:this.ajaxEndpoint,ep:{action:"doAction",id:e}})})}static newToken(){return btoa(String.fromCharCode(...window.crypto.getRandomValues(new Uint8Array(16))))}static storeResult(e,t){M[e]=JSON.parse(t)}static clearResult(e){if(Object.prototype.hasOwnProperty.call(M,e)){let t=M[e];return delete M[e],t}}loadAnnotations(e){let t=n.newToken(),r={action:"loadAnnotations",token:t};return typeof e=="string"||e instanceof String?r.format=e:e&&(e.includeText===!1&&(r.text=e.includeText),e.longArcs===!0&&(r.longArcs=e.longArcs),e.clipSpans===!1&&(r.clip=e.clipSpans),e.clipArcs===!1&&(r.clipArcs=e.clipArcs),e.format&&(r.format=e.format),e.range&&(r.begin=e.range[0],r.end=e.range[1])),new Promise((s,i)=>{Wicket.Ajax.ajax({m:"POST",u:this.ajaxEndpoint,ep:r,sh:[()=>{let o=n.clearResult(t);if(o===void 0){i(new Error("Server did not place result into transport buffer"));return}s(o)}],eh:[()=>{n.clearResult(t),i(new Error("Unable to load annotation"))}]})})}loadLazyDetails(e,t){let r=n.newToken(),s;Object.prototype.hasOwnProperty.call(e,"vid")?s=e.vid:s=e;let i;t?i=t:i=e.layer.id;let o={action:"normData",token:r,id:s,layerId:i};return new Promise((a,h)=>{Wicket.Ajax.ajax({m:"POST",u:this.ajaxEndpoint,ep:o,sh:[()=>{let l=n.clearResult(r);if(l===void 0){h(new Error("Server did not place result into transport buffer"));return}let c=[];for(let d of l){let g={title:d.title,details:[]};for(let f of d.details)g.details.push({label:f[0],value:f[1]});c.push(g)}a(c)}],eh:[()=>{n.clearResult(r),h(new Error("Unable to load lazy details"))}]})})}loadPreferences(e){let t=n.newToken(),r={action:"loadPreferences",token:t,key:e};return new Promise((s,i)=>{Wicket.Ajax.ajax({m:"POST",u:this.ajaxEndpoint,ep:r,sh:[()=>{let o=n.clearResult(t);if(o===void 0){i(new Error("Server did not place result into transport buffer"));return}s(o)}],eh:[()=>{n.clearResult(t),i(new Error("Unable to load preferences"))}]})})}savePreferences(e,t){let r=n.newToken(),s={action:"savePreferences",token:r,key:e,data:JSON.stringify(t)};return new Promise((i,o)=>{Wicket.Ajax.ajax({m:"POST",u:this.ajaxEndpoint,ep:s,sh:[()=>{n.clearResult(r),i()}],eh:[()=>{n.clearResult(r),o(new Error("Unable to save preferences"))}]})})}openContextMenu(e,t){let{clientX:r,clientY:s,overlay:i}=this.calculateClientPosition(t);n.performAjaxCall(()=>{new Promise((o,a)=>{Wicket.Ajax.ajax({m:"POST",u:this.ajaxEndpoint,ep:{action:"contextMenu",id:e,clientX:r,clientY:s},sh:[()=>{o()}],eh:[()=>{a(new Error("Unable to open context menu"))}]})}).then(()=>this.closeOverlayWhenContextMenuIsHidden(i))})}calculateClientPosition(e){var i,o;if(!e)return{clientX:Math.round(window.innerWidth/2),clientY:Math.round(window.innerHeight/2),overlay:void 0};let t=e.clientX,r=e.clientY,s;if((e==null?void 0:e.target)!=null&&"ownerDocument"in(e==null?void 0:e.target)){let h=(i=e.target.ownerDocument)==null?void 0:i.defaultView;if(window!==h){let l=(o=h==null?void 0:h.frameElement)==null?void 0:o.id;if(l){let c=parent.window.document.getElementById(l),d=c==null?void 0:c.getBoundingClientRect();d&&c&&(t+=d.left,r+=d.top,s=this.createOverlay(c))}}}return t=Math.round(t),r=Math.round(r),{clientX:t,clientY:r,overlay:s}}createOverlay(e){var r;let t=document.createElement("div");return t.style.position="absolute",t.style.top="0px",t.style.left="0px",t.style.width=`${e.clientWidth}px`,t.style.height=`${e.clientHeight}px`,t.style.zIndex="100",(r=e.parentElement)==null||r.insertBefore(t,e),t}closeOverlayWhenContextMenuIsHidden(e){var s;if(!e)return;let t=(s=e.parentElement)==null?void 0:s.querySelector(".context-menu");if(!t)return;let r=()=>{t.style.display==="none"?e.remove():setTimeout(r,20)};setTimeout(r,20)}};var G=class{createWebsocketClient(){return new j}createAjaxClient(e){return new $(e)}};var Ae=new G;function Oe(){return Ae}return ce(Ce);})();
/*! Bundled license information:

fast-json-patch/module/helpers.mjs:
  (*!
   * https://github.com/Starcounter-Jack/JSON-Patch
   * (c) 2017-2022 Joachim Wester
   * MIT licensed
   *)

fast-json-patch/module/duplex.mjs:
  (*!
   * https://github.com/Starcounter-Jack/JSON-Patch
   * (c) 2017-2021 Joachim Wester
   * MIT license
   *)
*/
//# sourceMappingURL=Diam.min.js.map
